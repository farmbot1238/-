<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرسة الشهيد سائد الثانوية للبنين</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #1a4d8f; /* أزرق وزارة التربية والتعليم */
            --secondary-color: #d4af37; /* ذهبي */
            --accent-color: #1a4d8f;
            --success-color: #2e8b57;
            --warning-color: #dd6b20;
            --danger-color: #c53030;
            --light-color: #f7fafc;
            --dark-color: #2d3748;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: 
                /* خلفية متدرجة بالألوان الرسمية */
                linear-gradient(135deg, #1a4d8f 0%, #0d2d5e 100%),
                /* نمط خلفية رسمي */
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.05) 20px);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }
        
        /* إضافة شعار الوزارة في الخلفية */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                /* شعار الوزارة (محاكاة) */
                radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                /* نمط خلفية عربي */
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(255,255,255,0.02) 50px, rgba(255,255,255,0.02) 51px);
            z-index: -1;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: 
                /* خلفية رأس الصفحة */
                linear-gradient(135deg, rgba(26, 77, 143, 0.95) 0%, rgba(13, 45, 94, 0.95) 100%),
                /* نمط خلفية */
                repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(212, 175, 55, 0.1) 5px, rgba(212, 175, 55, 0.1) 10px);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-radius: 0 0 15px 15px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        /* إضافة شعار الوزارة في الرأس */
        header::before {
            content: "";
            position: absolute;
            top: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            background: 
                radial-gradient(circle at center, #d4af37 0%, #b8941f 100%),
                /* شعار الوزارة (محاكاة) */
                linear-gradient(135deg, transparent 40%, #1a4d8f 40%, #1a4d8f 60%, transparent 60%),
                linear-gradient(45deg, transparent 40%, #1a4d8f 40%, #1a4d8f 60%, transparent 60%);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .main-title {
            font-size: 28px;
            margin: 10px 0;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .card {
            background: 
                /* خلفية البطاقات */
                linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%),
                /* نمط خلفية */
                repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(26, 77, 143, 0.03) 5px, rgba(26, 77, 143, 0.03) 10px);
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(26, 77, 143, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #d4af37 0%, #1a4d8f 100%);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .user-type-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .user-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #0d2d5e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }
        
        .user-btn::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .user-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #0d2d5e 0%, var(--primary-color) 100%);
        }
        
        .user-btn:hover::before {
            opacity: 1;
        }
        
        .form-container {
            display: none;
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 24px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            position: relative;
        }
        
        .form-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 50px;
            height: 2px;
            background: #d4af37;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s, box-shadow 0.3s;
            background: rgba(255, 255, 255, 0.8);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 77, 143, 0.2);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #236e48 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .submit-btn::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #236e48 0%, var(--success-color) 100%);
        }
        
        .submit-btn:hover::before {
            opacity: 1;
        }
        
        .teacher-dashboard, .student-dashboard {
            display: none;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
            color: var(--primary-color);
            background: linear-gradient(135deg, #e6f2ff 0%, #f0f7ff 100%);
            padding: 15px;
            border-radius: 10px;
            border-right: 5px solid var(--accent-color);
        }
        
        .dashboard-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .option-card {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }
        
        .option-card h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .option-card p {
            color: var(--secondary-color);
            margin-bottom: 20px;
            flex-grow: 1;
        }
        
        .exam-form {
            display: none;
        }
        
        .question-container {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #f8fafc;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .results-table th, .results-table td {
            border: 1px solid #e2e8f0;
            padding: 14px;
            text-align: center;
        }
        
        .results-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .results-table tr:hover {
            background-color: #edf2f7;
        }
        
        .notification {
            padding: 16px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .success {
            background-color: #f0fff4;
            color: #276749;
            border: 1px solid #9ae6b4;
        }
        
        .error {
            background-color: #fed7d7;
            color: #9b2c2c;
            border: 1px solid #feb2b2;
        }
        
        .info {
            background-color: #ebf8ff;
            color: #2c5aa0;
            border: 1px solid #90cdf4;
        }
        
        .code-display {
            background: linear-gradient(135deg, #1a4d8f 0%, #0d2d5e 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
            letter-spacing: 3px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .section-title {
            font-size: 22px;
            color: var(--primary-color);
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #2c5aa0 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c53030 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #c05621 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            background: 
                linear-gradient(135deg, rgba(26, 77, 143, 0.9) 0%, rgba(13, 45, 94, 0.9) 100%),
                repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(212, 175, 55, 0.1) 5px, rgba(212, 175, 55, 0.1) 10px);
            color: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #d4af37 0%, transparent 100%);
        }
        
        .exam-card {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .exam-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .exam-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            background-color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .back-btn {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #4a5568 0%, #718096 100%);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .exam-question {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
        }
        
        .question-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .question-marks {
            background: var(--accent-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-label:hover {
            background-color: #f7fafc;
            border-color: var(--accent-color);
        }
        
        .option-label input {
            margin-left: 10px;
        }
        
        .correct-answer {
            background-color: #f0fff4;
            border: 2px solid #38a169;
            color: #276749;
        }
        
        .wrong-answer {
            background-color: #fed7d7;
            border: 2px solid #e53e3e;
            color: #9b2c2c;
        }
        
        .answer-explanation {
            margin-top: 10px;
            padding: 10px;
            background-color: #ebf8ff;
            border-radius: 5px;
            border-right: 3px solid var(--accent-color);
        }

        @media (max-width: 768px) {
            .user-type-selection {
                flex-direction: column;
                align-items: center;
            }
            
            .user-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .dashboard-options {
                grid-template-columns: 1fr;
            }
            
            .exam-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            header::before {
                width: 40px;
                height: 40px;
                top: 5px;
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">مدرسة الشهيد سائد الثانوية للبنين</div>
            <h1 class="main-title">نظام الامتحانات الإلكتروني</h1>
            <p style="color: rgba(255,255,255,0.8); margin-top: 10px;">عمل الطالب: عبدالرحمن أحمد المعايطه</p>
        </div>
    </header>

    <div class="container">
        <!-- شاشة اختيار نوع المستخدم -->
        <div id="user-selection" class="card">
            <h2 class="form-title">اختر نوع المستخدم</h2>
            <div class="user-type-selection">
                <button class="user-btn" onclick="showTeacherForm()">معلم</button>
                <button class="user-btn" onclick="showStudentForm()">طالب</button>
            </div>
        </div>

        <!-- نموذج تسجيل المعلم -->
        <div id="teacher-form" class="card form-container">
            <button class="back-btn" onclick="goBack()">← رجوع</button>
            <h2 class="form-title">تسجيل المعلم</h2>
            <div class="form-group">
                <label for="teacher-name">اسم المعلم</label>
                <input type="text" id="teacher-name" placeholder="أدخل اسمك الكامل">
            </div>
            <div class="form-group">
                <label for="teacher-phone">رقم الهاتف</label>
                <input type="tel" id="teacher-phone" placeholder="أدخل رقم هاتفك">
            </div>
            <div class="form-group">
                <label for="teacher-subject">المادة</label>
                <select id="teacher-subject">
                    <option value="">اختر المادة</option>
                    <option value="arabic">اللغة العربية</option>
                    <option value="english">اللغة الإنجليزية</option>
                    <option value="math">الرياضيات</option>
                    <option value="religion">التربية الإسلامية</option>
                    <option value="physics">الفيزياء</option>
                    <option value="biology">الأحياء</option>
                    <option value="earth-science">علوم الأرض</option>
                    <option value="chemistry">الكيمياء</option>
                    <option value="finance">المالية</option>
                    <option value="history">التاريخ</option>
                    <option value="geography-national">الجغرافيا والوطنية</option>
                    <option value="jordan-history">تاريخ الأردن</option>
                </select>
            </div>
            <button class="submit-btn" onclick="registerTeacher()" id="register-teacher-btn">
                <span id="register-teacher-text">تسجيل وإنشاء كود</span>
                <div class="loading" id="register-teacher-loading" style="display: none;"></div>
            </button>
            
            <div class="section-title" style="margin-top: 30px;">لديك كود مسبقاً؟</div>
            <div class="form-group">
                <label for="teacher-code">أدخل الكود الخاص بك</label>
                <input type="text" id="teacher-code" placeholder="أدخل الكود الخاص بك">
                <button class="submit-btn" onclick="loginTeacher()" id="login-teacher-btn">
                    <span id="login-teacher-text">دخول</span>
                    <div class="loading" id="login-teacher-loading" style="display: none;"></div>
                </button>
            </div>
        </div>

        <!-- نموذج دخول الطالب -->
        <div id="student-form" class="card form-container">
            <button class="back-btn" onclick="goBack()">← رجوع</button>
            <h2 class="form-title">دخول الطالب</h2>
            <div class="form-group">
                <label for="student-name">اسم الطالب</label>
                <input type="text" id="student-name" placeholder="أدخل اسمك الكامل">
            </div>
            <div class="form-group">
                <label for="student-grade">الصف</label>
                <select id="student-grade">
                    <option value="">اختر الصف</option>
                    <option value="7">الصف السابع</option>
                    <option value="8">الصف الثامن</option>
                    <option value="9">الصف التاسع</option>
                    <option value="10">الصف العاشر</option>
                    <option value="11">الصف الأول ثانوي</option>
                </select>
            </div>
            <div class="form-group">
                <label for="student-section">الشعبة</label>
                <select id="student-section">
                    <option value="">اختر الشعبة</option>
                    <option value="A">أ</option>
                    <option value="B">ب</option>
                    <option value="C">ج</option>
                </select>
            </div>
            <div class="form-group">
                <label for="student-subject">المادة</label>
                <select id="student-subject">
                    <option value="">اختر المادة</option>
                    <option value="arabic">اللغة العربية</option>
                    <option value="english">اللغة الإنجليزية</option>
                    <option value="math">الرياضيات</option>
                    <option value="religion">التربية الإسلامية</option>
                    <option value="physics">الفيزياء</option>
                    <option value="biology">الأحياء</option>
                    <option value="earth-science">علوم الأرض</option>
                    <option value="chemistry">الكيمياء</option>
                    <option value="finance">المالية</option>
                    <option value="history">التاريخ</option>
                    <option value="geography-national">الجغرافيا والوطنية</option>
                    <option value="jordan-history">تاريخ الأردن</option>
                </select>
            </div>
            <button class="submit-btn" onclick="loginStudent()" id="login-student-btn">
                <span id="login-student-text">دخول</span>
                <div class="loading" id="login-student-loading" style="display: none;"></div>
            </button>
        </div>

        <!-- لوحة تحكم المعلم -->
        <div id="teacher-dashboard" class="teacher-dashboard">
            <button class="back-btn" onclick="logout()">← تسجيل الخروج</button>
            <div class="welcome-message">مرحباً، أستاذ <span id="teacher-name-display"></span></div>
            
            <div class="dashboard-options">
                <div class="option-card" onclick="showCreateExamForm()">
                    <h3>إنشاء امتحان جديد</h3>
                    <p>إنشاء امتحان جديد للطلاب مع تحديد الفصل والشهر والصف والشعبة</p>
                    <div class="btn btn-primary">بدء الإنشاء</div>
                </div>
                <div class="option-card" onclick="showExamResults()">
                    <h3>عرض نتائج الطلاب</h3>
                    <p>عرض نتائج الطلاب في الامتحانات مع إمكانية التصفية حسب الفصل والصف والشعبة</p>
                    <div class="btn btn-primary">عرض النتائج</div>
                </div>
                <div class="option-card" onclick="showTeacherCode()">
                    <h3>الكود الخاص بي</h3>
                    <p>عرض الكود الخاص بك للدخول مستقبلاً من أي جهاز</p>
                    <div class="btn btn-primary">عرض الكود</div>
                </div>
            </div>

            <!-- نموذج إنشاء الامتحان -->
            <div id="create-exam-form" class="card exam-form">
                <button class="back-btn" onclick="showTeacherDashboard()">← رجوع</button>
                <h2 class="form-title">إنشاء امتحان جديد</h2>
                <div class="form-group">
                    <label for="exam-title">عنوان الامتحان</label>
                    <input type="text" id="exam-title" placeholder="أدخل عنوان الامتحان">
                </div>
                
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="exam-semester">الفصل الدراسي</label>
                        <select id="exam-semester">
                            <option value="first">الفصل الأول</option>
                            <option value="second">الفصل الثاني</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="exam-month">الشهر</label>
                        <select id="exam-month">
                            <option value="first">الشهر الأول</option>
                            <option value="second">الشهر الثاني</option>
                            <option value="fourth">الشهر الرابع</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="exam-grade">الصف</label>
                        <select id="exam-grade">
                            <option value="7">الصف السابع</option>
                            <option value="8">الصف الثامن</option>
                            <option value="9">الصف التاسع</option>
                            <option value="10">الصف العاشر</option>
                            <option value="11">الصف الأول ثانوي</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="exam-section">الشعبة</label>
                        <select id="exam-section">
                            <option value="A">أ</option>
                            <option value="B">ب</option>
                            <option value="C">ج</option>
                        </select>
                    </div>
                </div>
                
                <div id="questions-container">
                    <!-- سيتم إضافة الأسئلة هنا ديناميكياً -->
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addQuestion()">إضافة سؤال</button>
                    <button class="btn btn-success" onclick="saveExam()" id="save-exam-btn">
                        <span id="save-exam-text">حفظ الامتحان</span>
                        <div class="loading" id="save-exam-loading" style="display: none;"></div>
                    </button>
                </div>
            </div>

            <!-- عرض نتائج الطلاب -->
            <div id="exam-results" class="card exam-form">
                <button class="back-btn" onclick="showTeacherDashboard()">← رجوع</button>
                <h2 class="form-title">نتائج الطلاب</h2>
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="results-semester">الفصل الدراسي</label>
                        <select id="results-semester">
                            <option value="first">الفصل الأول</option>
                            <option value="second">الفصل الثاني</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="results-grade">الصف</label>
                        <select id="results-grade">
                            <option value="7">الصف السابع</option>
                            <option value="8">الصف الثامن</option>
                            <option value="9">الصف التاسع</option>
                            <option value="10">الصف العاشر</option>
                            <option value="11">الصف الأول ثانوي</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="results-section">الشعبة</label>
                        <select id="results-section">
                            <option value="A">أ</option>
                            <option value="B">ب</option>
                            <option value="C">ج</option>
                        </select>
                    </div>
                </div>
                <button class="submit-btn" onclick="loadResults()" id="load-results-btn">
                    <span id="load-results-text">عرض النتائج</span>
                    <div class="loading" id="load-results-loading" style="display: none;"></div>
                </button>
                
                <div id="results-table-container" style="margin-top: 20px;">
                    <!-- سيتم عرض النتائج هنا -->
                </div>
            </div>

            <!-- عرض الكود الخاص بالمعلم -->
            <div id="teacher-code-display" class="card exam-form">
                <button class="back-btn" onclick="showTeacherDashboard()">← رجوع</button>
                <h2 class="form-title">الكود الخاص بك</h2>
                <div class="code-display" id="teacher-code-value"></div>
                <p style="text-align: center; margin-top: 15px;">احفظ هذا الكود للدخول مستقبلاً من أي جهاز</p>
            </div>
        </div>

        <!-- لوحة تحكم الطالب -->
        <div id="student-dashboard" class="student-dashboard">
            <button class="back-btn" onclick="logout()">← تسجيل الخروج</button>
            <div class="welcome-message">مرحباً، <span id="student-name-display"></span></div>
            
            <div id="available-exams">
                <!-- سيتم عرض الامتحانات المتاحة هنا -->
            </div>
        </div>

        <!-- إشعارات -->
        <div id="notification" class="notification" style="display: none;"></div>
    </div>

    <footer>
        <div class="container">
            <p>مدرسة الشهيد سائد الثانوية للبنين - نظام الامتحانات الإلكتروني</p>
            <p style="margin-top: 10px; font-size: 14px; color: rgba(255,255,255,0.8);">
                عمل الطالب: عبدالرحمن أحمد المعايطه
            </p>
        </div>
    </footer>

    <script>
        // تهيئة Supabase مع البيانات المقدمة
        const SUPABASE_URL = 'https://fiacdguhzsabwgjhujpc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpYWNkZ3VoenNhYndnamh1anBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTY3MTIsImV4cCI6MjA3NTE5MjcxMn0.W30PQ0DAs9MQDskbUUkzbgfeYSCiR07-16s3IZxgoEI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // بيانات التطبيق
        let currentTeacher = null;
        let currentStudent = null;
        let questionCount = 0;

        // عرض نموذج المعلم
        function showTeacherForm() {
            document.getElementById('user-selection').style.display = 'none';
            document.getElementById('teacher-form').style.display = 'block';
        }

        // عرض نموذج الطالب
        function showStudentForm() {
            document.getElementById('user-selection').style.display = 'none';
            document.getElementById('student-form').style.display = 'block';
        }

        // الرجوع للخلف
        function goBack() {
            if (document.getElementById('teacher-dashboard').style.display === 'block' || 
                document.getElementById('student-dashboard').style.display === 'block') {
                logout();
            } else {
                document.getElementById('teacher-form').style.display = 'none';
                document.getElementById('student-form').style.display = 'none';
                document.getElementById('user-selection').style.display = 'block';
            }
        }

        // تسجيل الخروج
        function logout() {
            currentTeacher = null;
            currentStudent = null;
            
            document.getElementById('teacher-dashboard').style.display = 'none';
            document.getElementById('student-dashboard').style.display = 'none';
            document.getElementById('user-selection').style.display = 'block';
            
            // إخفاء جميع النماذج الفرعية
            document.getElementById('create-exam-form').style.display = 'none';
            document.getElementById('exam-results').style.display = 'none';
            document.getElementById('teacher-code-display').style.display = 'none';
            
            // إعادة تعيين الحقول
            document.getElementById('teacher-name').value = '';
            document.getElementById('teacher-phone').value = '';
            document.getElementById('teacher-subject').value = '';
            document.getElementById('teacher-code').value = '';
            document.getElementById('student-name').value = '';
            document.getElementById('student-grade').value = '';
            document.getElementById('student-section').value = '';
            document.getElementById('student-subject').value = '';
        }

        // تسجيل المعلم
        async function registerTeacher() {
            const name = document.getElementById('teacher-name').value;
            const phone = document.getElementById('teacher-phone').value;
            const subject = document.getElementById('teacher-subject').value;
            
            if (!name || !phone || !subject) {
                showNotification('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            // عرض تحميل
            showLoading('register-teacher');
            
            try {
                // التحقق من عدم تكرار اسم المعلم
                const { data: existingTeachers, error } = await supabase
                    .from('teachers')
                    .select('*')
                    .eq('name', name);
                
                if (error) throw error;
                
                if (existingTeachers && existingTeachers.length > 0) {
                    hideLoading('register-teacher');
                    showNotification('اسم المعلم مسجل مسبقاً، استخدم الكود الخاص بك للدخول', 'error');
                    return;
                }
                
                // إنشاء كود فريد للمعلم
                const code = generateCode();
                
                // حفظ بيانات المعلم في Supabase
                const { data: teacher, error: insertError } = await supabase
                    .from('teachers')
                    .insert([
                        { name, phone, subject, code }
                    ])
                    .select();
                
                if (insertError) throw insertError;
                
                // تسجيل الدخول
                currentTeacher = teacher[0];
                showTeacherDashboard();
                
                // عرض الكود
                document.getElementById('teacher-code-value').textContent = code;
                hideLoading('register-teacher');
                showNotification('تم تسجيلك بنجاح! كودك هو: ' + code, 'success');
            } catch (error) {
                console.error('Error registering teacher:', error);
                hideLoading('register-teacher');
                showNotification('حدث خطأ أثناء التسجيل: ' + error.message, 'error');
            }
        }

        // دخول المعلم باستخدام الكود
        async function loginTeacher() {
            const code = document.getElementById('teacher-code').value;
            
            if (!code) {
                showNotification('يرجى إدخال الكود', 'error');
                return;
            }
            
            // عرض تحميل
            showLoading('login-teacher');
            
            try {
                const { data: teacher, error } = await supabase
                    .from('teachers')
                    .select('*')
                    .eq('code', code)
                    .single();
                
                if (error) throw error;
                
                if (!teacher) {
                    hideLoading('login-teacher');
                    showNotification('الكود غير صحيح', 'error');
                    return;
                }
                
                currentTeacher = teacher;
                showTeacherDashboard();
                hideLoading('login-teacher');
                showNotification('مرحباً مرة أخرى، أستاذ ' + teacher.name, 'success');
            } catch (error) {
                console.error('Error logging in teacher:', error);
                hideLoading('login-teacher');
                showNotification('حدث خطأ أثناء تسجيل الدخول: ' + error.message, 'error');
            }
        }

        // دخول الطالب
        async function loginStudent() {
            const name = document.getElementById('student-name').value;
            const grade = document.getElementById('student-grade').value;
            const section = document.getElementById('student-section').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!name || !grade || !section || !subject) {
                showNotification('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            // عرض تحميل
            showLoading('login-student');
            
            try {
                // حفظ بيانات الطالب في Supabase (إذا لم يكن مسجلاً مسبقاً)
                let student;
                const { data: existingStudents, error: checkError } = await supabase
                    .from('students')
                    .select('*')
                    .eq('name', name)
                    .eq('grade', grade)
                    .eq('section', section);
                
                if (checkError) throw checkError;
                
                if (existingStudents && existingStudents.length > 0) {
                    student = existingStudents[0];
                } else {
                    // الحصول على IP الطالب (محاكاة)
                    const ip = await getStudentIP();
                    
                    const { data: newStudent, error: insertError } = await supabase
                        .from('students')
                        .insert([
                            { name, grade, section, ip }
                        ])
                        .select();
                    
                    if (insertError) throw insertError;
                    student = newStudent[0];
                }
                
                currentStudent = student;
                showStudentDashboard(subject);
                hideLoading('login-student');
                showNotification('مرحباً ' + name, 'success');
            } catch (error) {
                console.error('Error logging in student:', error);
                hideLoading('login-student');
                showNotification('حدث خطأ أثناء تسجيل الدخول: ' + error.message, 'error');
            }
        }

        // محاكاة الحصول على IP الطالب
        async function getStudentIP() {
            return 'IP_' + Math.random().toString(36).substring(2, 10);
        }

        // عرض لوحة تحكم المعلم
        function showTeacherDashboard() {
            document.getElementById('teacher-form').style.display = 'none';
            document.getElementById('teacher-dashboard').style.display = 'block';
            document.getElementById('teacher-name-display').textContent = currentTeacher.name;
            
            // إخفاء جميع النماذج الفرعية
            document.getElementById('create-exam-form').style.display = 'none';
            document.getElementById('exam-results').style.display = 'none';
            document.getElementById('teacher-code-display').style.display = 'none';
        }

        // عرض لوحة تحكم الطالب
        function showStudentDashboard(subject) {
            document.getElementById('student-form').style.display = 'none';
            document.getElementById('student-dashboard').style.display = 'block';
            document.getElementById('student-name-display').textContent = currentStudent.name;
            
            // عرض الامتحانات المتاحة
            loadAvailableExams(subject);
        }

        // عرض نموذج إنشاء الامتحان
        function showCreateExamForm() {
            document.getElementById('create-exam-form').style.display = 'block';
            document.getElementById('exam-results').style.display = 'none';
            document.getElementById('teacher-code-display').style.display = 'none';
            
            // إعادة تعيين النموذج
            document.getElementById('exam-title').value = '';
            document.getElementById('questions-container').innerHTML = '';
            questionCount = 0;
        }

        // عرض نتائج الامتحانات
        function showExamResults() {
            document.getElementById('create-exam-form').style.display = 'none';
            document.getElementById('exam-results').style.display = 'block';
            document.getElementById('teacher-code-display').style.display = 'none';
        }

        // عرض الكود الخاص بالمعلم
        function showTeacherCode() {
            document.getElementById('create-exam-form').style.display = 'none';
            document.getElementById('exam-results').style.display = 'none';
            document.getElementById('teacher-code-display').style.display = 'block';
            document.getElementById('teacher-code-value').textContent = currentTeacher.code;
        }

        // إضافة سؤال جديد مع علامات
        function addQuestion() {
            questionCount++;
            const questionHTML = `
                <div class="question-container" id="question-${questionCount}">
                    <div class="question-header">
                        <h3>السؤال ${questionCount}</h3>
                        <button class="btn btn-danger" onclick="removeQuestion(${questionCount})">حذف السؤال</button>
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-text">نص السؤال</label>
                        <input type="text" id="question-${questionCount}-text" placeholder="أدخل نص السؤال">
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-marks">العلامة</label>
                        <input type="number" id="question-${questionCount}-marks" placeholder="أدخل علامة السؤال" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-option1">الخيار الأول</label>
                        <input type="text" id="question-${questionCount}-option1" placeholder="أدخل الخيار الأول">
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-option2">الخيار الثاني</label>
                        <input type="text" id="question-${questionCount}-option2" placeholder="أدخل الخيار الثاني">
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-option3">الخيار الثالث</label>
                        <input type="text" id="question-${questionCount}-option3" placeholder="أدخل الخيار الثالث">
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-option4">الخيار الرابع</label>
                        <input type="text" id="question-${questionCount}-option4" placeholder="أدخل الخيار الرابع">
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-correct">الإجابة الصحيحة</label>
                        <select id="question-${questionCount}-correct">
                            <option value="1">الخيار الأول</option>
                            <option value="2">الخيار الثاني</option>
                            <option value="3">الخيار الثالث</option>
                            <option value="4">الخيار الرابع</option>
                        </select>
                    </div>
                </div>
            `;
            
            document.getElementById('questions-container').innerHTML += questionHTML;
        }

        // حذف سؤال
        function removeQuestion(questionId) {
            document.getElementById(`question-${questionId}`).remove();
        }

        // حفظ الامتحان مع العلامات
        async function saveExam() {
            const title = document.getElementById('exam-title').value;
            const semester = document.getElementById('exam-semester').value;
            const month = document.getElementById('exam-month').value;
            const grade = document.getElementById('exam-grade').value;
            const section = document.getElementById('exam-section').value;
            
            if (!title || questionCount === 0) {
                showNotification('يرجى إدخال عنوان الامتحان وإضافة أسئلة', 'error');
                return;
            }
            
            // جمع بيانات الأسئلة مع العلامات
            const questions = [];
            for (let i = 1; i <= questionCount; i++) {
                const questionElement = document.getElementById(`question-${i}`);
                if (!questionElement) continue;
                
                const questionText = document.getElementById(`question-${i}-text`).value;
                const marks = parseInt(document.getElementById(`question-${i}-marks`).value) || 1;
                const option1 = document.getElementById(`question-${i}-option1`).value;
                const option2 = document.getElementById(`question-${i}-option2`).value;
                const option3 = document.getElementById(`question-${i}-option3`).value;
                const option4 = document.getElementById(`question-${i}-option4`).value;
                const correct = document.getElementById(`question-${i}-correct`).value;
                
                if (questionText && option1 && option2 && option3 && option4) {
                    questions.push({
                        text: questionText,
                        marks: marks,
                        options: [option1, option2, option3, option4],
                        correct: parseInt(correct)
                    });
                }
            }
            
            if (questions.length === 0) {
                showNotification('يرجى إدخال بيانات جميع الأسئلة', 'error');
                return;
            }
            
            // حساب العلامة الكلية
            const totalMarks = questions.reduce((sum, question) => sum + question.marks, 0);
            
            // عرض تحميل
            showLoading('save-exam');
            
            try {
                // حفظ الامتحان في Supabase
                const { data: exam, error } = await supabase
                    .from('exams')
                    .insert([
                        {
                            teacher_id: currentTeacher.id,
                            title,
                            semester,
                            month,
                            grade,
                            section,
                            subject: currentTeacher.subject,
                            questions,
                            total_marks: totalMarks,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                hideLoading('save-exam');
                showNotification(`تم حفظ الامتحان بنجاح! العلامة الكلية: ${totalMarks}`, 'success');
                showTeacherDashboard();
            } catch (error) {
                console.error('Error saving exam:', error);
                hideLoading('save-exam');
                showNotification('حدث خطأ أثناء حفظ الامتحان: ' + error.message, 'error');
            }
        }

        // تحميل الامتحانات المتاحة للطالب
        async function loadAvailableExams(subject) {
            const availableExamsContainer = document.getElementById('available-exams');
            availableExamsContainer.innerHTML = '<h2 class="section-title">الامتحانات المتاحة</h2>';
            
            try {
                // تصفية الامتحانات حسب المادة والصف والشعبة
                const { data: filteredExams, error } = await supabase
                    .from('exams')
                    .select('*')
                    .eq('subject', subject)
                    .eq('grade', currentStudent.grade)
                    .eq('section', currentStudent.section);
                
                if (error) throw error;
                
                if (!filteredExams || filteredExams.length === 0) {
                    availableExamsContainer.innerHTML += '<p style="text-align: center;">لا توجد امتحانات متاحة حالياً</p>';
                    return;
                }
                
                filteredExams.forEach(exam => {
                    // التحقق إذا الطالب قدّم الامتحان مسبقاً
                    checkIfExamSubmitted(exam.id).then(submitted => {
                        const examCard = document.createElement('div');
                        examCard.className = 'exam-card';
                        
                        if (submitted) {
                            examCard.innerHTML = `
                                <h3>${exam.title} ✅</h3>
                                <div class="exam-meta">
                                    <div class="meta-item">الفصل: ${exam.semester === 'first' ? 'الأول' : 'الثاني'}</div>
                                    <div class="meta-item">الشهر: ${exam.month === 'first' ? 'الأول' : exam.month === 'second' ? 'الثاني' : 'الرابع'}</div>
                                    <div class="meta-item">الصف: ${exam.grade}</div>
                                    <div class="meta-item">الشعبة: ${exam.section}</div>
                                    <div class="meta-item">العلامة الكلية: ${exam.total_marks || exam.questions?.reduce((sum, q) => sum + (q.marks || 1), 0) || 'غير محدد'}</div>
                                </div>
                                <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                    <p style="color: #276749; font-weight: bold;">✅ لقد قدمت هذا الامتحان مسبقاً</p>
                                </div>
                                <button class="btn btn-secondary" onclick="viewExamResults('${exam.id}')">عرض النتيجة</button>
                            `;
                        } else {
                            examCard.innerHTML = `
                                <h3>${exam.title}</h3>
                                <div class="exam-meta">
                                    <div class="meta-item">الفصل: ${exam.semester === 'first' ? 'الأول' : 'الثاني'}</div>
                                    <div class="meta-item">الشهر: ${exam.month === 'first' ? 'الأول' : exam.month === 'second' ? 'الثاني' : 'الرابع'}</div>
                                    <div class="meta-item">الصف: ${exam.grade}</div>
                                    <div class="meta-item">الشعبة: ${exam.section}</div>
                                    <div class="meta-item">العلامة الكلية: ${exam.total_marks || exam.questions?.reduce((sum, q) => sum + (q.marks || 1), 0) || 'غير محدد'}</div>
                                </div>
                                <button class="btn btn-primary" onclick="startRealExam('${exam.id}')">بدء الامتحان</button>
                            `;
                        }
                        availableExamsContainer.appendChild(examCard);
                    });
                });
            } catch (error) {
                console.error('Error loading exams:', error);
                showNotification('حدث خطأ أثناء تحميل الامتحانات: ' + error.message, 'error');
            }
        }

        // التحقق إذا الطالب قدّم الامتحان مسبقاً
        async function checkIfExamSubmitted(examId) {
            try {
                const { data, error } = await supabase
                    .from('results')
                    .select('*')
                    .eq('exam_id', examId)
                    .eq('student_id', currentStudent.id)
                    .single();
                
                return !!data;
            } catch (error) {
                return false;
            }
        }

        // بدء الامتحان الحقيقي
        async function startRealExam(examId) {
            try {
                const exam = await getExamById(examId);
                if (!exam) {
                    showNotification('الامتحان غير موجود', 'error');
                    return;
                }

                // إنشاء واجهة الامتحان
                const examHTML = `
                    <div class="card">
                        <button class="back-btn" onclick="showStudentDashboard('${currentStudent.subject}')">← رجوع</button>
                        <h2 class="form-title">${exam.title}</h2>
                        <div class="exam-meta">
                            <div class="meta-item">الفصل: ${exam.semester === 'first' ? 'الأول' : 'الثاني'}</div>
                            <div class="meta-item">الشهر: ${exam.month === 'first' ? 'الأول' : exam.month === 'second' ? 'الثاني' : 'الرابع'}</div>
                            <div class="meta-item">الصف: ${exam.grade}</div>
                            <div class="meta-item">الشعبة: ${exam.section}</div>
                            <div class="meta-item">العلامة الكلية: ${exam.total_marks || exam.questions?.reduce((sum, q) => sum + (q.marks || 1), 0) || 'غير محدد'}</div>
                        </div>
                        
                        <form id="exam-form">
                            ${exam.questions.map((question, index) => `
                                <div class="exam-question">
                                    <div class="question-marks">${question.marks || 1} علامة</div>
                                    <div class="question-text">
                                        السؤال ${index + 1}: ${question.text}
                                    </div>
                                    <div class="options-container">
                                        ${question.options.map((option, optIndex) => `
                                            <label class="option-label">
                                                <input type="radio" name="question-${index}" value="${optIndex + 1}" required>
                                                ${option}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                            
                            <button type="button" class="submit-btn" onclick="submitRealExam('${exam.id}')">تسليم الإجابات</button>
                        </form>
                    </div>
                `;

                document.getElementById('available-exams').innerHTML = examHTML;
                
            } catch (error) {
                console.error('Error starting exam:', error);
                showNotification('حدث خطأ أثناء تحميل الامتحان', 'error');
            }
        }

        // عرض نتيجة الامتحان
        async function viewExamResults(examId) {
            try {
                const exam = await getExamById(examId);
                const { data: result, error } = await supabase
                    .from('results')
                    .select('*')
                    .eq('exam_id', examId)
                    .eq('student_id', currentStudent.id)
                    .single();
                
                if (error) throw error;

                const resultHTML = `
                    <div class="card">
                        <button class="back-btn" onclick="showStudentDashboard('${currentStudent.subject}')">← رجوع</button>
                        <h2 class="form-title">نتيجة الامتحان: ${exam.title}</h2>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 24px; margin: 20px 0;">
                                <p>العلامة: <strong>${result.marks_obtained || result.score}/${result.total_marks || exam.total_marks}</strong></p>
                                <p>النسبة: <strong>${result.score}%</strong></p>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showStudentDashboard('${currentStudent.subject}')">خروج</button>
                    </div>
                `;

                document.getElementById('available-exams').innerHTML = resultHTML;
                
            } catch (error) {
                console.error('Error viewing results:', error);
                showNotification('حدث خطأ أثناء عرض النتيجة', 'error');
            }
        }

        // تسليم الإجابات الحقيقية
        async function submitRealExam(examId) {
            try {
                const exam = await getExamById(examId);
                const form = document.getElementById('exam-form');
                const formData = new FormData(form);
                
                let score = 0;
                let totalMarks = 0;
                
                // حساب النتيجة
                exam.questions.forEach((question, index) => {
                    const userAnswer = parseInt(formData.get(`question-${index}`));
                    const correctAnswer = question.correct;
                    const questionMarks = question.marks || 1;
                    
                    totalMarks += questionMarks;
                    
                    if (userAnswer === correctAnswer) {
                        score += questionMarks;
                    }
                });

                const percentage = Math.round((score / totalMarks) * 100);
                
                // حفظ النتيجة
                const { data: result, error } = await supabase
                    .from('results')
                    .insert([
                        {
                            exam_id: examId,
                            student_id: currentStudent.id,
                            student_name: currentStudent.name,
                            score: percentage,
                            marks_obtained: score,
                            total_marks: totalMarks,
                            submitted_at: new Date().toISOString()
                        }
                    ])
                    .select();

                if (error) throw error;

                // عرض النتيجة النهائية
                showFinalResults(exam, score, totalMarks, percentage);
                
            } catch (error) {
                console.error('Error submitting exam:', error);
                showNotification('حدث خطأ أثناء تسليم الإجابات', 'error');
            }
        }

        // عرض النتيجة النهائية مع الإجابات النموذجية
        function showFinalResults(exam, score, totalMarks, percentage) {
            let resultsHTML = `
                <div class="card">
                    <h2 class="form-title">نتيجة الامتحان: ${exam.title}</h2>
                    <div style="text-align: center; padding: 20px; background: #f0fff4; border-radius: 10px; margin: 20px 0;">
                        <h3 style="color: var(--success-color);">✅ تم تسليم الامتحان بنجاح</h3>
                        <div style="font-size: 24px; margin: 20px 0;">
                            <p>العلامة: <strong>${score}/${totalMarks}</strong></p>
                            <p>النسبة: <strong>${percentage}%</strong></p>
                        </div>
                    </div>
                    
                    <h3 class="section-title">الإجابات النموذجية</h3>
            `;

            // عرض الأسئلة مع الإجابات الصحيحة
            exam.questions.forEach((question, index) => {
                const correctAnswer = question.options[question.correct - 1];
                resultsHTML += `
                    <div class="exam-question">
                        <div class="question-marks">${question.marks || 1} علامة</div>
                        <div class="question-text">
                            السؤال ${index + 1}: ${question.text}
                        </div>
                        <div class="options-container">
                            ${question.options.map((option, optIndex) => {
                                const isCorrect = (optIndex + 1) === question.correct;
                                return `
                                    <label class="option-label ${isCorrect ? 'correct-answer' : ''}">
                                        <input type="radio" disabled ${isCorrect ? 'checked' : ''}>
                                        ${option} ${isCorrect ? '✓' : ''}
                                    </label>
                                `;
                            }).join('')}
                        </div>
                        <div class="answer-explanation">
                            <strong>الإجابة الصحيحة:</strong> ${correctAnswer}
                        </div>
                    </div>
                `;
            });

            resultsHTML += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="showStudentDashboard('${currentStudent.subject}')">خروج</button>
                </div>
            </div>
            `;

            document.getElementById('available-exams').innerHTML = resultsHTML;
        }

        // الحصول على بيانات الامتحان
        async function getExamById(examId) {
            try {
                const { data: exam, error } = await supabase
                    .from('exams')
                    .select('*')
                    .eq('id', examId)
                    .single();
                
                if (error) throw error;
                return exam;
            } catch (error) {
                console.error('Error getting exam:', error);
                return null;
            }
        }

        // تحميل نتائج الطلاب
        async function loadResults() {
            const semester = document.getElementById('results-semester').value;
            const grade = document.getElementById('results-grade').value;
            const section = document.getElementById('results-section').value;
            
            const resultsContainer = document.getElementById('results-table-container');
            resultsContainer.innerHTML = '';
            
            // عرض تحميل
            showLoading('load-results');
            
            try {
                // تصفية النتائج حسب المعلم الحالي والفصل والصف والشعبة
                const { data: teacherExams, error: examsError } = await supabase
                    .from('exams')
                    .select('id, title, total_marks')
                    .eq('teacher_id', currentTeacher.id)
                    .eq('semester', semester)
                    .eq('grade', grade)
                    .eq('section', section);
                
                if (examsError) throw examsError;
                
                if (!teacherExams || teacherExams.length === 0) {
                    hideLoading('load-results');
                    resultsContainer.innerHTML = '<p style="text-align: center;">لا توجد نتائج متاحة</p>';
                    return;
                }
                
                const examIds = teacherExams.map(exam => exam.id);
                const { data: filteredResults, error: resultsError } = await supabase
                    .from('results')
                    .select('*')
                    .in('exam_id', examIds);
                
                if (resultsError) throw resultsError;
                
                if (!filteredResults || filteredResults.length === 0) {
                    hideLoading('load-results');
                    resultsContainer.innerHTML = '<p style="text-align: center;">لا توجد نتائج متاحة</p>';
                    return;
                }
                
                let tableHTML = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>اسم الطالب</th>
                                <th>الامتحان</th>
                                <th>العلامة</th>
                                <th>النسبة</th>
                                <th>تاريخ التقديم</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                filteredResults.forEach(result => {
                    const exam = teacherExams.find(e => e.id === result.exam_id);
                    tableHTML += `
                        <tr>
                            <td>${result.student_name}</td>
                            <td>${exam ? exam.title : 'غير معروف'}</td>
                            <td>${result.marks_obtained || 0}/${result.total_marks || exam?.total_marks || '?'}</td>
                            <td>${result.score}%</td>
                            <td>${new Date(result.submitted_at).toLocaleDateString('ar-EG')}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                resultsContainer.innerHTML = tableHTML;
                hideLoading('load-results');
            } catch (error) {
                console.error('Error loading results:', error);
                hideLoading('load-results');
                showNotification('حدث خطأ أثناء تحميل النتائج: ' + error.message, 'error');
            }
        }

        // عرض الإشعارات
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // عرض تحميل
        function showLoading(buttonId) {
            document.getElementById(`${buttonId}-text`).style.display = 'none';
            document.getElementById(`${buttonId}-loading`).style.display = 'inline-block';
            document.getElementById(`${buttonId}-btn`).disabled = true;
        }

        // إخفاء تحميل
        function hideLoading(buttonId) {
            document.getElementById(`${buttonId}-text`).style.display = 'inline';
            document.getElementById(`${buttonId}-loading`).style.display = 'none';
            document.getElementById(`${buttonId}-btn`).disabled = false;
        }

        // إنشاء كود فريد
        function generateCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // تهيئة التطبيق
        function initApp() {
            // إخفاء جميع النماذج واللوحات
            document.getElementById('teacher-form').style.display = 'none';
            document.getElementById('student-form').style.display = 'none';
            document.getElementById('teacher-dashboard').style.display = 'none';
            document.getElementById('student-dashboard').style.display = 'none';
            document.getElementById('notification').style.display = 'none';
        }

        // تشغيل التطبيق عند تحميل الصفحة
        window.onload = initApp;
    </script>
</body>
</html>
